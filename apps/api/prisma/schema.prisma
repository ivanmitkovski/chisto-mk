// Chisto.mk â€” Prisma schema
// Civic environmental platform: pollution reporting, site lifecycle, cleanup events

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  firstName    String
  lastName     String
  email        String   @unique
  phoneNumber  String   @unique
  passwordHash String
  role         Role     @default(USER)
  status       UserStatus @default(ACTIVE)
  isPhoneVerified Boolean @default(false)

  pointsBalance     Int @default(0)
  totalPointsEarned Int @default(0)
  totalPointsSpent  Int @default(0)
  lastActiveAt      DateTime?

  reports      Report[]
  pointTransactions PointTransaction[]

  @@index([role])
  @@index([status])
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model PointTransaction {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  delta       Int
  balanceAfter Int
  reasonCode  String
  referenceType String?
  referenceId   String?
  metadata    Json?

  @@index([userId, createdAt])
  @@index([reasonCode])
}

// Canonical pollution/report site
model Site {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  latitude    Float
  longitude   Float
  description String?
  status      SiteStatus @default(REPORTED)

  reports     Report[]
  events      CleanupEvent[]

  @@index([status])
  @@index([latitude, longitude])
}

enum SiteStatus {
  REPORTED
  VERIFIED
  CLEANUP_SCHEDULED
  IN_PROGRESS
  CLEANED
  DISPUTED
}

// User-submitted pollution report
model Report {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  reporterId String?
  reporter   User?    @relation(fields: [reporterId], references: [id], onDelete: SetNull)

  description String?
  mediaUrls   String[] @default([])

  status    ReportStatus @default(PENDING)

  @@index([siteId])
  @@index([reporterId])
  @@index([status])
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
}

// Cleanup event at a site
model CleanupEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  scheduledAt DateTime
  completedAt DateTime?

  organizerId String?
  participantCount Int @default(0)

  @@index([siteId])
  @@index([scheduledAt])
}
